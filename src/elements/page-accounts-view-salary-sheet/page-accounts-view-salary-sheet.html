<link rel="import" href="../../bower-assets/paper-card/paper-card.html">
<link rel="import" href="../../bower-assets/vaadin-grid/vaadin-grid.html">
<!-- style -->
<link rel="import" href="../../styles/common-style.html">

<!-- behavior -->
<link rel="import" href="../../behaviors/translating.html">
<link rel="import" href="../../behaviors/page-like.html">
<link rel="import" href="../../behaviors/api-calling.html">
<link rel="import" href="../../behaviors/db-using.html">
<link rel="import" href="../../behaviors/common-computes.html">

<dom-module id="page-accounts-view-salary-sheet">

  <template>
    <!-- style -->
    <style is="custom-style" include="common-style">
      .limiting-container {
        width: 100%;
        margin: 0;
      }
    </style>

    <paper-card class="m-top-8">
      <div class="card-content">

        <vaadin-grid items="[[salarySheet.data]]">
          <vaadin-grid-column resizable frozen>
            <template class="header">Employee Id</template>
            <template>
              <span>[[item.employeeId]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable frozen>
            <template class="header">Employee Name</template>
            <template>
              <span>[[item.employeeName]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable frozen>
            <template class="header">Basic Salary</template>
            <template>
              <span>[[item.salaryUnitPrice]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable frozen>
            <template class="header">Unit</template>
            <template>
              <span>[[item.salaryUnit]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable frozen>
            <template class="header">Total Basic Salary</template>
            <template>
              <span>[[getTotal(item.salaryUnitPrice, item.salaryUnit)]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable frozen>
            <template class="header">Total Days Worked</template>
            <template>
              <span>[[item.dayCount]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Overtime/Unit</template>
            <template>
              <span>[[item.overtimeUnitPrice]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Unit</template>
            <template>
              <span>[[item.overtimeUnit]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Total Overtime</template>
            <template>
              <span>[[getTotal(item.overtimeUnitPrice, item.overtimeUnit)]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Festival Bonus/Unit</template>
            <template>
              <span>[[item.festivalBonusUnitPrice]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Unit</template>
            <template>
              <span>[[item.festivalBonusUnit]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Total Bonus</template>
            <template>
              <span>[[getTotal(item.festivalBonusUnitPrice, item.festivalBonusUnit)]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">House Rent</template>
            <template>
              <span>[[item.houseRent]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Conveyance</template>
            <template>
              <span>[[item.conveyance]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Medical Allowance</template>
            <template>
              <span>[[item.medicalAllowance]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Education</template>
            <template>
              <span>[[item.education]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">LFC</template>
            <template>
              <span>[[item.lfc]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Dues Paid</template>
            <template>
              <span>[[item.dues]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Advance Taken</template>
            <template>
              <span>[[item.advances]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Tax Deduction</template>
            <template>
              <span>[[item.taxDeduction]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Insurance</template>
            <template>
              <span>[[item.insurance]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Provident Fund</template>
            <template>
              <span>[[item.providentFund]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Gratuity</template>
            <template>
              <span>[[item.gratuityFund]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Advance Deduction</template>
            <template>
              <span>[[item.advanceDeduction]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Gross Salary</template>
            <template>
              <span class="type primary">[[item.grossSalary]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Total Deductibles</template>
            <template>
              <span class="type danger">[[item.totalDeductibles]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Net Salary</template>
            <template>
              <span class="type bold">[[item.netSalary]]</span>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column resizable>
            <template class="header">Paid</template>
            <template>
              <span class="type bold success">[[item.paid]]</span>
            </template>
          </vaadin-grid-column>
        </vaadin-grid>

        <div class="layout vertical">
          <div class="layout horizontal m-top-8 type title-2 bold">
            <label for="" class="flex">Total Salary Expense</label>
            <div class="">
              [[$toTwoDecimalPlace(salarySheet.totalSalaryExpense)]]
            </div>
          </div>
        </div>

      </div>

    </paper-card>


  </template>

  <script>
    Polymer({
      is: 'page-accounts-view-salary-sheet',
      behaviors: [
        app.behaviors.translating,
        app.behaviors.pageLike,
        app.behaviors.dbUsing,
        app.behaviors.apiCalling,
        app.behaviors.commonComputes
      ],

      properties: {
        user: {
          type: Object,
          notify: true,
          value: null
        },
        organization: {
          type: Object,
          value: {}
        },
        salarySheet: {
          type: Object,
          value: {}
        },
        totalSalaryExpense: Number,
        loading: {
          type: Boolean,
          value: false
        }
      },

      navigatedIn() {
        const params = this.domHost.getPageParams()
        let { organization, salary } = params;
        this._loadUser();
        if (organization) {
          this._loadOrganization(organization, () => {
            this._loadSalarySheet(salary)
          });
        } else {
          this._notifyInvalidOrganization()
        }
      },

      _loadUser() {
        const userList = app.db.find('user');
        if (userList.length === 1) {
          return this.user = userList[0];
        }
      },

      _loadOrganization(idOnServer, cbfn) {
        const data = {
          apiKey: this.user.apiKey,
          idList: [idOnServer]
        };
        this.loading = true;
        this.callApi('/bdemr-organization-list-organizations-by-ids', data, (err, response) => {
          this.loading = false;
          if (response.hasError) return this.domHost.showModalDialog(response.error.message);
          if (!response.data.matchingOrganizationList.length) return this._notifyInvalidOrganization();
          this.set('organization', response.data.matchingOrganizationList[0]);
          return cbfn();
        });
      },

      _notifyInvalidOrganization() {
        return this.domHost.showModalDialog("Invalid Organization");
      },

      _loadSalarySheet(salarySheetIdentifier) {
        this.loading = true;
        this.callApi('/bdemr-organization-get-salary-sheet', { apiKey: this.user.apiKey, id: salarySheetIdentifier }, (err, response) => {
          this.loading = false;
          if (err) return this.domHost.showModalDialog(err.message);
          if (response.hasError) return this.domHost.showModalDialog(response.error.message);
          let salarySheet = response.data[0];
          this.set('salarySheet', salarySheet)
        })
      },

      getTotal(unitPrice = 0, unit = 1) {
        return parseInt(unitPrice) * parseInt(unit);
      },

      arrowBackButtonPressed() {
        return this.domHost.navigateToPreviousPage();
      }


    })
  </script>

</dom-module>